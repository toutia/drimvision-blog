{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="exam-container">
  {% if submitted %}
    <!-- RESULTS VIEW -->
    <h1>Exam Results</h1>
    <p>
      Score: {{ score.earned_points }} / {{ score.total_points }} ({{ score.percentage }}%)
    </p>

    <div>
      {% for detail in details %}
        <div {% if detail.is_correct %}class="correct"{% else %}class="incorrect"{% endif %}>
          <pre>{{ forloop.counter }}. {{ detail.question }}</pre>
          <ul>
            {% for label, option in detail.options.items %}
              <li>
                <strong>{{ label }})</strong> {{ option }}
                {% if label in detail.correct_answers %}<span class="correct-icon">✔</span>{% endif %}
                {% if label in detail.selected and label not in detail.correct_answers %}<span class="incorrect-icon">✖</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
          <p>
            <strong>Selected:</strong> {{ detail.selected|join:", " }} |
            <strong>Points:</strong> {{ detail.points }}
          </p>
          {% if detail.explanation %}
            <pre class="explanation"><strong>Explanation:</strong> {{ detail.explanation }}</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>

  {% else %}
    <!-- ONGOING QUESTION VIEW -->
    <div>
      <h1>Question {{ current_index|add:1 }} of {{ total }} ({{ question.points }} Points)</h1>

      {{question.question_text}}
      <div id="timer">
        Time left: <span id="time-remaining">{{ remaining_time }} </span> min
      </div>
    </div>

    <div>
      <pre>{{ question.text }}</pre>
    </div>

    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="current_index" value="{{ current_index }}">

      {% for label, option in question.choices.items %}
        <label>
          <input
            type="checkbox"
            name="q_{{ question.id }}"
            value="{{ label }}"
            {% if label in selected_labels %}checked{% endif %}
          >
          <span>{{ label }})</span>
          <span>{{ option }}</span>
        </label>
      {% endfor %}

      <div>
        {% if current_index > 0 %}
          <button type="submit" name="prev">Previous</button>
        {% endif %}

        {% if current_index|add:1 < total %}
          <button type="submit" name="next">Next</button>
        {% endif %}
        <button type="submit">Submit Exam</button>
      </div>
    </form>

    <!-- TIMER SCRIPT in minutes:seconds -->
    <script>
      const timerEl = document.getElementById('time-remaining');
      let timeLeft = timerEl.textContent;
      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return m + ':' + (s < 10 ? '0' + s : s);
      }

      timerEl.textContent = formatTime(timeLeft);

      const timer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = formatTime(timeLeft);

        if (timeLeft <= 0) {
          clearInterval(timer);
          document.querySelector('form').submit();
        }
      }, 1000);
    </script>
  {% endif %}
</div>
{% endblock %}
